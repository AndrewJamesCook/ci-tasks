name: batch

on:
  schedule:
    - cron: '0 1 * * *'
    - cron: '0 10 * * *'
    - cron: '0 13 * * *'
    - cron: '0 22 * * *'
  workflow_dispatch:

concurrency:
  group: src-write
  cancel-in-progress: false

permissions:
  contents: read

env:
  GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
  APIFY_API_TOKEN: ${{ secrets.APIFY_API_TOKEN }}
  DEVICE_ID: github-actions-harvest
  PYTHONPATH: .

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Init
        run: |
          git clone --depth 1 ${{ secrets.SOURCE_REPO_URL }} .
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Deps
        run: pip install --no-cache-dir -r requirements.txt

      - name: Verify deps
        run: python -c "from supabase import create_client; from jsonschema import validate; import httpx; import pydantic; print('All critical imports OK')"

      - name: Preflight
        run: python tools/preflight_check.py --critical-only --fix

      - name: Cache browsers
        id: pw-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: pw-${{ runner.os }}-${{ hashFiles('requirements.txt') }}

      - name: Install browsers
        run: |
          if [ "${{ steps.pw-cache.outputs.cache-hit }}" = "true" ]; then
            playwright install-deps chromium
          else
            playwright install --with-deps chromium
          fi

      # ── Stage 01 ───────────────────────────────────────────
      - name: "Pre-flight: Stage 01"
        continue-on-error: true
        run: python tools/preflight_check.py --stage 01 --critical-only

      - name: Harvest
        id: s01
        timeout-minutes: 20
        run: |
          for attempt in 1 2; do
            if python tools/run_stage.py 01; then exit 0; fi
            [ $attempt -lt 2 ] && sleep 30
          done
          exit 1

      - name: "Post-flight: Stage 01"
        if: always()
        continue-on-error: true
        run: |
          if [ "${{ steps.s01.outcome }}" = "failure" ]; then
            python tools/self_heal.py --diagnose-stage 01 --error "boost harvest failed" --execute || true
          fi

      - name: Push
        run: |
          git add data/pain_items_raw.json data/harvest_metrics.json
          if ! git diff --staged --quiet; then
            ITEMS=$(python -c "import json; print(len(json.load(open('data/pain_items_raw.json'))))" 2>/dev/null || echo "?")
            git commit -m "chore: harvest (${ITEMS} items)"
            git fetch --unshallow origin master 2>/dev/null || git fetch origin master 2>/dev/null || true
            if ! git push 2>/dev/null; then
              echo "Push failed, attempting pull with merge..."
              if ! git pull --no-rebase origin master 2>/dev/null; then
                echo "Merge conflict detected, resolving data/ files with ours..."
                git checkout --ours data/ config/ 2>/dev/null || true
                git add data/ config/ 2>/dev/null || true
                git commit --no-edit 2>/dev/null || true
              fi
              git push
            fi
          fi

      - name: Alert
        if: failure()
        env:
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          REPORT_EMAIL: ${{ secrets.REPORT_EMAIL }}
        run: |
          pip install resend 2>/dev/null || true
          python tools/notify_failure.py harvest-boost "01:failure"

      - name: Summary
        if: always()
        run: |
          python -c "
          import json
          m = json.load(open('data/harvest_metrics.json'))
          total = m.get('total_items', 0)
          sources = m.get('sources', {})
          print(f'Harvest: {total} new from {len(sources)} sources')
          raw = json.load(open('data/pain_items_raw.json'))
          print(f'Corpus: {len(raw)} total')
          "
# ci-tasks runner
