name: proc

on:
  schedule:
    - cron: '0 7 * * *'
    - cron: '0 19 * * *'
  workflow_dispatch:

concurrency:
  group: src-write
  cancel-in-progress: false

permissions:
  contents: read

env:
  GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
  XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
  RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
  REPORT_EMAIL: ${{ secrets.REPORT_EMAIL }}
  NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
  DEVICE_ID: github-actions
  PYTHONPATH: .
  BATCH_SYNC: "1"

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Init
        run: |
          git clone --depth 1 ${{ secrets.SOURCE_REPO_URL }} .
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Deps
        run: pip install --no-cache-dir -r requirements.txt

      - name: Verify deps
        run: python -c "from supabase import create_client; from jsonschema import validate; import httpx; import pydantic; print('All critical imports OK')"

      - name: Preflight
        run: python tools/preflight_check.py --critical-only --fix

      - name: Tests
        run: python -m pytest tests/test_static.py tests/test_contracts.py tests/test_smoke.py -v --timeout=60

      - name: Cache browsers
        id: pw-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: pw-${{ runner.os }}-${{ hashFiles('requirements.txt') }}

      - name: Install browsers
        run: |
          if [ "${{ steps.pw-cache.outputs.cache-hit }}" = "true" ]; then
            playwright install-deps chromium
          else
            playwright install --with-deps chromium
          fi

      - name: Cache models
        uses: actions/cache@v4
        with:
          path: ~/.cache/huggingface/hub
          key: hf-all-MiniLM-L6-v2

      - name: Load model
        run: python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('all-MiniLM-L6-v2')"

      - name: Service checks
        continue-on-error: true
        run: python tools/preflight_check.py --stage council --fix

      # ── Council (morning only) ─────────────────────────────
      - name: Metrics
        if: github.event.schedule == '0 7 * * *' || github.event_name == 'workflow_dispatch'
        run: python tools/strategy_review.py --mode morning

      - name: Council
        if: github.event.schedule == '0 7 * * *' || github.event_name == 'workflow_dispatch'
        run: python tools/strategy_council.py --fallback-to-subagents --mode morning

      # ── Stage 01 ───────────────────────────────────────────
      - name: "Pre-flight: Stage 01"
        continue-on-error: true
        run: python tools/preflight_check.py --stage 01 --critical-only

      - name: S01
        id: s01
        continue-on-error: true
        timeout-minutes: 20
        run: |
          for attempt in 1 2 3; do
            if python tools/run_stage.py 01; then
              echo "s01=success" >> "$GITHUB_OUTPUT"; exit 0
            fi
            [ $attempt -lt 3 ] && sleep 30
          done
          echo "s01=failed" >> "$GITHUB_OUTPUT"; exit 1

      - name: "Post-flight: Stage 01"
        if: always()
        continue-on-error: true
        run: |
          if [ "${{ steps.s01.outcome }}" = "failure" ]; then
            python tools/self_heal.py --diagnose-stage 01 --error "Stage 01 failed after retries" --execute || true
          fi

      # ── Stage 02 ───────────────────────────────────────────
      - name: "Pre-flight: Stage 02"
        continue-on-error: true
        run: python tools/preflight_check.py --stage 02 --critical-only

      - name: S02
        id: s02
        continue-on-error: true
        timeout-minutes: 28
        run: |
          for attempt in 1 2 3; do
            if python tools/run_stage.py 02; then
              echo "s02=success" >> "$GITHUB_OUTPUT"; exit 0
            fi
            [ $attempt -lt 3 ] && sleep 30
          done
          echo "s02=failed" >> "$GITHUB_OUTPUT"; exit 1

      - name: "Post-flight: Stage 02"
        if: always()
        continue-on-error: true
        run: |
          if [ "${{ steps.s02.outcome }}" = "failure" ]; then
            python tools/self_heal.py --diagnose-stage 02 --error "Stage 02 failed after retries" --execute || true
          fi

      # ── Stage 02b ──────────────────────────────────────────
      - name: "Pre-flight: Stage 02b"
        continue-on-error: true
        run: python tools/preflight_check.py --stage 02b --critical-only

      - name: S02b
        id: s02b
        continue-on-error: true
        timeout-minutes: 5
        run: |
          for attempt in 1 2; do
            if python tools/run_stage.py 02b; then exit 0; fi
            [ $attempt -lt 2 ] && sleep 15
          done
          exit 1

      - name: "Post-flight: Stage 02b"
        if: always()
        continue-on-error: true
        run: |
          if [ "${{ steps.s02b.outcome }}" = "failure" ]; then
            python tools/self_heal.py --diagnose-stage 02b --error "Stage 02b failed" --execute || true
          fi

      # ── Stage 03 ───────────────────────────────────────────
      - name: "Pre-flight: Stage 03"
        continue-on-error: true
        run: python tools/preflight_check.py --stage 03 --critical-only

      - name: S03
        id: s03
        continue-on-error: true
        timeout-minutes: 5
        run: |
          for attempt in 1 2 3; do
            if python tools/run_stage.py 03; then
              echo "s03=success" >> "$GITHUB_OUTPUT"; exit 0
            fi
            [ $attempt -lt 3 ] && sleep 30
          done
          echo "s03=failed" >> "$GITHUB_OUTPUT"; exit 1

      - name: "Post-flight: Stage 03"
        if: always()
        continue-on-error: true
        run: |
          if [ "${{ steps.s03.outcome }}" = "failure" ]; then
            python tools/self_heal.py --diagnose-stage 03 --error "Stage 03 failed after retries" --execute || true
          fi

      # ── Stage 04 ───────────────────────────────────────────
      - name: "Pre-flight: Stage 04"
        continue-on-error: true
        run: python tools/preflight_check.py --stage 04 --critical-only

      - name: S04
        id: s04
        continue-on-error: true
        timeout-minutes: 5
        run: |
          for attempt in 1 2 3; do
            if python tools/run_stage.py 04; then
              echo "s04=success" >> "$GITHUB_OUTPUT"; exit 0
            fi
            [ $attempt -lt 3 ] && sleep 30
          done
          echo "s04=failed" >> "$GITHUB_OUTPUT"; exit 1

      - name: "Post-flight: Stage 04"
        if: always()
        continue-on-error: true
        run: |
          if [ "${{ steps.s04.outcome }}" = "failure" ]; then
            python tools/self_heal.py --diagnose-stage 04 --error "Stage 04 failed after retries" --execute || true
          fi

      # ── Stage 05 ───────────────────────────────────────────
      - name: "Pre-flight: Stage 05"
        continue-on-error: true
        run: python tools/preflight_check.py --stage 05 --critical-only

      - name: S05
        id: s05
        continue-on-error: true
        timeout-minutes: 15
        run: |
          for attempt in 1 2 3; do
            if python tools/run_stage.py 05; then
              echo "s05=success" >> "$GITHUB_OUTPUT"; exit 0
            fi
            [ $attempt -lt 3 ] && sleep 30
          done
          echo "s05=failed" >> "$GITHUB_OUTPUT"; exit 1

      - name: "Post-flight: Stage 05"
        if: always()
        continue-on-error: true
        run: |
          if [ "${{ steps.s05.outcome }}" = "failure" ]; then
            python tools/self_heal.py --diagnose-stage 05 --error "Stage 05 failed after retries" --execute || true
          fi

      # ── Stage 05b ──────────────────────────────────────────
      - name: "Pre-flight: Stage 05b"
        continue-on-error: true
        run: python tools/preflight_check.py --stage 05b --critical-only

      - name: S05b
        id: s05b
        continue-on-error: true
        timeout-minutes: 5
        run: for a in 1 2; do python tools/run_stage.py 05b && exit 0; [ $a -lt 2 ] && sleep 15; done; exit 1

      - name: "Post-flight: Stage 05b"
        if: always()
        continue-on-error: true
        run: |
          if [ "${{ steps.s05b.outcome }}" = "failure" ]; then
            python tools/self_heal.py --diagnose-stage 05b --error "Stage 05b failed" --execute || true
          fi

      # ── Stage 05c ──────────────────────────────────────────
      - name: "Pre-flight: Stage 05c"
        continue-on-error: true
        run: python tools/preflight_check.py --stage 05c --critical-only

      - name: S05c
        id: s05c
        continue-on-error: true
        timeout-minutes: 5
        run: for a in 1 2; do python tools/run_stage.py 05c && exit 0; [ $a -lt 2 ] && sleep 15; done; exit 1

      - name: "Post-flight: Stage 05c"
        if: always()
        continue-on-error: true
        run: |
          if [ "${{ steps.s05c.outcome }}" = "failure" ]; then
            python tools/self_heal.py --diagnose-stage 05c --error "Stage 05c failed" --execute || true
          fi

      # ── Stage 06 ───────────────────────────────────────────
      - name: "Pre-flight: Stage 06"
        continue-on-error: true
        run: python tools/preflight_check.py --stage 06 --critical-only

      - name: S06
        id: s06
        continue-on-error: true
        timeout-minutes: 15
        run: python tools/run_stage.py 06

      - name: "Post-flight: Stage 06"
        if: always()
        continue-on-error: true
        run: |
          if [ "${{ steps.s06.outcome }}" = "failure" ]; then
            python tools/self_heal.py --diagnose-stage 06 --error "Stage 06 failed" --execute || true
          fi

      # ── Stage 06b ──────────────────────────────────────────
      - name: "Pre-flight: Stage 06b"
        continue-on-error: true
        run: python tools/preflight_check.py --stage 06b --critical-only

      - name: S06b
        id: s06b
        continue-on-error: true
        timeout-minutes: 5
        run: python tools/run_stage.py 06b

      - name: "Post-flight: Stage 06b"
        if: always()
        continue-on-error: true
        run: |
          if [ "${{ steps.s06b.outcome }}" = "failure" ]; then
            python tools/self_heal.py --diagnose-stage 06b --error "Stage 06b failed" --execute || true
          fi

      # ── Stage 07 ───────────────────────────────────────────
      - name: "Pre-flight: Stage 07"
        continue-on-error: true
        run: python tools/preflight_check.py --stage 07 --critical-only

      - name: S07
        id: s07
        continue-on-error: true
        timeout-minutes: 5
        run: python tools/run_stage.py 07

      - name: "Post-flight: Stage 07"
        if: always()
        continue-on-error: true
        run: |
          if [ "${{ steps.s07.outcome }}" = "failure" ]; then
            python tools/self_heal.py --diagnose-stage 07 --error "Stage 07 failed" --execute || true
          fi

      # ── Stage 08 ───────────────────────────────────────────
      - name: "Pre-flight: Stage 08"
        continue-on-error: true
        run: python tools/preflight_check.py --stage 08 --critical-only

      - name: S08
        id: s08
        continue-on-error: true
        timeout-minutes: 5
        run: python tools/run_stage.py 08

      - name: "Post-flight: Stage 08"
        if: always()
        continue-on-error: true
        run: |
          if [ "${{ steps.s08.outcome }}" = "failure" ]; then
            python tools/self_heal.py --diagnose-stage 08 --error "Stage 08 failed" --execute || true
          fi

      # ── Stage 09 ───────────────────────────────────────────
      - name: "Pre-flight: Stage 09"
        continue-on-error: true
        run: python tools/preflight_check.py --stage 09 --critical-only

      - name: S09
        id: s09
        continue-on-error: true
        timeout-minutes: 10
        run: python tools/run_stage.py 09

      - name: "Post-flight: Stage 09"
        if: always()
        continue-on-error: true
        run: |
          if [ "${{ steps.s09.outcome }}" = "failure" ]; then
            python tools/self_heal.py --diagnose-stage 09 --error "Stage 09 failed" --execute || true
          fi

      # ── Stage 10 ───────────────────────────────────────────
      - name: "Pre-flight: Stage 10"
        continue-on-error: true
        run: python tools/preflight_check.py --stage 10 --critical-only

      - name: S10
        id: s10
        continue-on-error: true
        timeout-minutes: 5
        run: python tools/run_stage.py 10

      - name: "Post-flight: Stage 10"
        if: always()
        continue-on-error: true
        run: |
          if [ "${{ steps.s10.outcome }}" = "failure" ]; then
            python tools/self_heal.py --diagnose-stage 10 --error "Stage 10 failed" --execute || true
          fi

      # ── Health ─────────────────────────────────────────────
      - name: Health
        if: always()
        run: |
          python tools/self_heal.py --check-pipeline-health \
            --stages \
              "01:${{ steps.s01.outcome || 'skipped' }}" \
              "02:${{ steps.s02.outcome || 'skipped' }}" \
              "03:${{ steps.s03.outcome || 'skipped' }}" \
              "04:${{ steps.s04.outcome || 'skipped' }}" \
              "05:${{ steps.s05.outcome || 'skipped' }}"

      # ── Maintenance ────────────────────────────────────────
      - name: Prune
        continue-on-error: true
        run: |
          python -c "
          from tools.utils.supabase_client import get_client
          from datetime import datetime, timedelta, timezone
          sb = get_client()
          if sb.is_available():
              cutoff = (datetime.now(timezone.utc) - timedelta(days=180)).isoformat()
              tbl = sb._table('scraped_ids')
              if tbl:
                  resp = tbl.delete().lt('created_at', cutoff).execute()
                  count = len(resp.data) if resp and resp.data else 0
                  print(f'Pruned {count} scraped_ids older than 180 days')
          "

      - name: Sync
        continue-on-error: true
        run: python -c "from tools.run_stage import sync_all_to_supabase; sync_all_to_supabase()"

      # ── Commit back to source ──────────────────────────────
      - name: Push
        run: |
          git add data/ config/ data/quick_flow_specs/ || true
          if ! git diff --staged --quiet; then
            DATE=$(date -u +%Y-%m-%d)
            ITEMS=$(python -c "import json; print(len(json.load(open('data/pain_items_raw.json'))))" 2>/dev/null || echo "?")
            git commit -m "chore: pipeline run ${DATE} (${ITEMS} items)"
            git fetch --unshallow origin master 2>/dev/null || git fetch origin master 2>/dev/null || true
            git pull --ff-only origin master 2>/dev/null || git pull --no-rebase origin master 2>/dev/null || true
            git push
          fi

      - name: Tag
        run: |
          TAG="pipeline-$(date -u +%Y-%m-%d)"
          if ! git tag -l "$TAG" | grep -q .; then
            git tag "$TAG" -m "Daily snapshot $(date -u +%Y-%m-%d)"
            git push origin "$TAG"
          fi

      - name: Backup
        if: always()
        env:
          TIGRIS_ACCESS_KEY: ${{ secrets.TIGRIS_ACCESS_KEY }}
          TIGRIS_SECRET_KEY: ${{ secrets.TIGRIS_SECRET_KEY }}
          TIGRIS_BUCKET: wat-backups
        run: python tools/backup.py || true

      - name: Alert
        if: failure()
        env:
          S01: ${{ steps.s01.outcome }}
          S02: ${{ steps.s02.outcome }}
          S03: ${{ steps.s03.outcome }}
          S04: ${{ steps.s04.outcome }}
          S05: ${{ steps.s05.outcome }}
        run: |
          pip install resend 2>/dev/null || true
          python tools/notify_failure.py daily-pipeline \
            "01:${S01:-skipped}" "02:${S02:-skipped}" "03:${S03:-skipped}" \
            "04:${S04:-skipped}" "05:${S05:-skipped}"

      - name: Summary
        if: always()
        run: python tools/ci_summary.py
# ci-tasks runner
